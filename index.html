<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ShopEasy - Shop</title>
</head>
<body>
  <h1>ShopEasy ðŸ›’</h1>

  <div id="authStatus"></div>
  <button id="logoutBtn" style="display:none;">Log Out</button>

  <h2>Items for Sale</h2>
  <div id="items"></div>

  <h2>Your Cart</h2>
  <div id="cart"></div>
  <button id="saveCartBtn" style="display:none;">Save Cart</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      onSnapshot,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // Firebase config (same as before)
    const firebaseConfig = {
      apiKey: "AIzaSyABT1dlkE7m0k9pLtP_l5mhk10NRlNoDb8",
      authDomain: "nofootage2010.firebaseapp.com",
      projectId: "nofootage2010",
      storageBucket: "nofootage2010.firebasestorage.app",
      messagingSenderId: "1098446374131",
      appId: "1:1098446374131:web:499c1e6a2d5d781adae386"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const itemsDiv = document.getElementById("items");
    const cartDiv = document.getElementById("cart");
    const logoutBtn = document.getElementById("logoutBtn");
    const saveCartBtn = document.getElementById("saveCartBtn");
    const authStatus = document.getElementById("authStatus");

    let cart = [];
    let user = null;

    // Show items to everyone
    onSnapshot(collection(db, "items"), (snapshot) => {
      itemsDiv.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.padding = "10px";
        div.style.marginBottom = "10px";

        div.innerHTML = `
          <strong>${data.name}</strong> - $${data.price} (${data.quantity} left)<br>
          <em>${data.description}</em><br>
          <button>Add to Cart</button>
        `;

        const btn = div.querySelector("button");
        btn.onclick = () => {
          if (!user) {
            if (confirm("You must log in to add items to your cart. Go to login page?")) {
              window.location.href = "login.html";
            }
            return;
          }
          addToCart(docSnap.id, data.name, data.price);
        };

        itemsDiv.appendChild(div);
      });
    });

    onAuthStateChanged(auth, (u) => {
      user = u;
      if (user) {
        authStatus.textContent = `Logged in as ${user.email}`;
        logoutBtn.style.display = "inline-block";
        saveCartBtn.style.display = "inline-block";
        loadCart();
      } else {
        authStatus.innerHTML = `Not logged in. <a href="login.html">Login or Sign Up</a>`;
        logoutBtn.style.display = "none";
        saveCartBtn.style.display = "none";
        cart = [];
        renderCart();
      }
    });

    logoutBtn.onclick = () => {
      signOut(auth);
    };

    function addToCart(id, name, price) {
      const existing = cart.find(i => i.id === id);
      if (existing) {
        existing.quantity++;
      } else {
        cart.push({ id, name, price, quantity: 1 });
      }
      renderCart();
    }

    function renderCart() {
      cartDiv.innerHTML = "";
      cart.forEach(item => {
        const div = document.createElement("div");
        div.textContent = `${item.name} - $${item.price} x ${item.quantity}`;
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "Remove";
        removeBtn.onclick = () => {
          cart = cart.filter(i => i.id !== item.id);
          renderCart();
        };
        div.appendChild(removeBtn);
        cartDiv.appendChild(div);
      });
    }

    saveCartBtn.onclick = async () => {
      if (!user) {
        alert("Please log in to save your cart.");
        return;
      }
      await setDoc(doc(db, "carts", user.uid), { items: cart });
      alert("Cart saved!");
    };

    async function loadCart() {
      if (!user) return;
      const cartDoc = await getDoc(doc(db, "carts", user.uid));
      if (cartDoc.exists()) {
        cart = cartDoc.data().items || [];
        renderCart();
      }
    }
  </script>
</body>
</html>
